(function(){"use strict";let k,t,v=0,p=0;const c=6;let A=6.674,q=4e5,f,u,D="simple",w=0;const E=5e4,H=25;function L(r){for(let e=2;e<p;e++){const s=e*3,o=e*c,a=t[o];if(a>99998)continue;const l=t[o+1],_=t[o+2],m=-a,h=-l,M=-_,x=m*m+h*h+M*M;if(x<1e4){t[o]=99999,w++;continue}const n=A*q/x,y=1/Math.sqrt(x);let i=m*y*n,d=h*y*n,g=M*y*n;const I=t[c],P=t[c+1],b=t[c+2],z=I-a,S=P-l,T=b-_,B=z*z+S*S+T*T;if(B>100){const C=A*E/B,R=1/Math.sqrt(B);i+=z*R*C,d+=S*R*C,g+=T*R*C}f[s]=i,f[s+1]=d,f[s+2]=g}}function N(r,e){for(let s=2;s<p;s++){const o=s*3,a=s*c;let l=0,_=0,m=0;const h=t[a];if(h>99998)continue;const M=t[a+1],x=t[a+2];for(let n=0;n<p;n++){if(s===n)continue;const y=t[n*c];if(y>99998)continue;const i=t[n*c+1],d=t[n*c+2],g=y-h,I=i-M,P=d-x;let b=g*g+I*I+P*P;if(e&&s>1&&n>1&&b<H){t[n*c]=99999,w++;continue}if(b<400){n===0&&(t[a]=99999,w++);continue}const z=A*u[n]/b,S=1/Math.sqrt(b);l+=g*S*z,_+=I*S*z,m+=P*S*z}f[o]=l,f[o+1]=_,f[o+2]=m}}function O(r){for(let e=2;e<p;e++){const s=e*c,o=e*3;t[s]>99998||(t[s+3]+=f[o]*r,t[s+4]+=f[o+1]*r,t[s+5]+=f[o+2]*r,t[s]+=t[s+3]*r,t[s+1]+=t[s+4]*r,t[s+2]+=t[s+5]*r)}}let F;function Q(){F&&clearInterval(F),F=setInterval(()=>{const r=performance.now();if(p>2){const s=.016666666666666666;D==="simple"?L():N(s,D==="extreme"),O(s)}const e=performance.now()-r;self.postMessage({type:"physics_report",physicsStepTime:e,consumedParticles:w})},1e3/60)}self.onmessage=r=>{const{type:e,...s}=r.data;if(e==="init")k=s.sharedBuffer,v=s.maxParticles,q=s.blackHoleMass,t=new Float32Array(k),f=new Float32Array(v*3),u=new Float32Array(v),u[0]=q,u[1]=E,p=2,Q(),self.postMessage({type:"ready"});else if(e==="set_particles"){const o=Math.min(v,s.count);for(let a=p;a<o;a++){const l=a*c,_=2e3+Math.random()*8e3,m=2*Math.PI*Math.random(),h=Math.acos(2*Math.random()-1)-Math.PI/2,M=_*Math.cos(m)*Math.cos(h),x=_*Math.sin(h)*.5,n=_*Math.sin(m)*Math.cos(h);t[l]=M,t[l+1]=x,t[l+2]=n;const y=Math.sqrt(A*q/_)*(.8+Math.random()*.2),i=new Float32Array([-n,0,M]),d=Math.sqrt(i[0]*i[0]+i[2]*i[2]);d>1e-9&&(i[0]/=d,i[2]/=d),t[l+3]=i[0]*y,t[l+4]=(Math.random()-.5)*20,t[l+5]=i[2]*y,u[a]=1+Math.random()*5}p=o}else e==="set_mass"?(q=s.mass,u&&(u[0]=q)):e==="set_quality"?D=s.quality:e==="reset"?(p=2,w=0):e==="update_moon"&&(t[c]=s.x,t[c+1]=s.y,t[c+2]=s.z)}})();
