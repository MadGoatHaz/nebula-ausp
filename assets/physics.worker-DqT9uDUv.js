(function(){"use strict";let t,h,x,w=0,l=0;const c=6;let v=6.674,q=4e5,E="simple",A=0;const B=5e4,L=25;function N(i){for(let n=2;n<l;n++){const s=n*3,e=n*c,f=t[e];if(f>99998)continue;const m=t[e+1],r=t[e+2],_=-f,u=-m,y=-r,d=_*_+u*u+y*y;if(d<1e4){t[e]=99999,A++;continue}const o=v*q/d,M=1/Math.sqrt(d);let S=_*M*o,a=u*M*o,p=y*M*o;const g=t[c],I=t[c+1],P=t[c+2],z=g-f,b=I-m,F=P-r,D=z*z+b*b+F*F;if(D>100){const C=v*B/D,R=1/Math.sqrt(D);S+=z*R*C,a+=b*R*C,p+=F*R*C}h[s]=S,h[s+1]=a,h[s+2]=p}}function k(i,n){for(let s=2;s<l;s++){const e=s*3,f=s*c;let m=0,r=0,_=0;const u=t[f];if(u>99998)continue;const y=t[f+1],d=t[f+2];for(let o=0;o<l;o++){if(s===o)continue;const M=t[o*c];if(M>99998)continue;const S=t[o*c+1],a=t[o*c+2],p=M-u,g=S-y,I=a-d;let P=p*p+g*g+I*I;if(n&&s>1&&o>1&&P<L){t[o*c]=99999,A++;continue}if(P<400){o===0&&(t[f]=99999,A++);continue}const z=v*x[o]/P,b=1/Math.sqrt(P);m+=p*b*z,r+=g*b*z,_+=I*b*z}h[e]=m,h[e+1]=r,h[e+2]=_}}function H(i){for(let n=2;n<l;n++){const s=n*c,e=n*3;t[s]>99998||(t[s+3]+=h[e]*i,t[s+4]+=h[e+1]*i,t[s+5]+=h[e+2]*i,t[s]+=t[s+3]*i,t[s+1]+=t[s+4]*i,t[s+2]+=t[s+5]*i)}}let T;function O(){T&&clearInterval(T),T=setInterval(()=>{const i=performance.now();if(l>2){const s=.016666666666666666;E==="simple"?N():k(s,E==="extreme"),H(s)}const n=performance.now()-i;self.postMessage({type:"physics_update",physicsStepTime:n,consumedParticles:A,data:t.buffer})},1e3/60)}self.onmessage=i=>{const{type:n,...s}=i.data;if(n==="init"){w=s.maxParticles,q=s.blackHoleMass;const e=new ArrayBuffer(w*c*Float32Array.BYTES_PER_ELEMENT);t=new Float32Array(e),h=new Float32Array(w*3),x=new Float32Array(w),x[0]=q,x[1]=B,l=2,O()}else if(n==="set_particles"){const e=Math.min(w-2,s.count),f=l;if(l=e+2,l>f)for(let m=f;m<l;m++){const r=m*c,_=2e3+Math.random()*8e3,u=2*Math.PI*Math.random(),y=Math.acos(2*Math.random()-1)-Math.PI/2,d=_*Math.cos(u)*Math.cos(y),o=_*Math.sin(y)*.5,M=_*Math.sin(u)*Math.cos(y);t[r]=d,t[r+1]=o,t[r+2]=M;const S=Math.sqrt(v*q/_)*(.8+Math.random()*.2),a=new Float32Array([-M,0,d]),p=Math.sqrt(a[0]*a[0]+a[2]*a[2]);p>1e-9&&(a[0]/=p,a[2]/=p),t[r+3]=a[0]*S,t[r+4]=(Math.random()-.5)*20,t[r+5]=a[2]*S,x[m]=1+Math.random()*5}}else if(n==="set_mass")q=s.mass,x&&(x[0]=q);else if(n==="set_quality")E=s.quality;else if(n==="reset")l=2,A=0;else if(n==="update_moon"){if(!t)return;t[c]=s.x,t[c+1]=s.y,t[c+2]=s.z}}})();
