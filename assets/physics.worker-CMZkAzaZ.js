(function(){"use strict";let k,t,v=0,l=0;const o=6;let A=6.674,g=4e5,h,x,D="simple",b=0;const E=5e4,H=25;function L(i){for(let e=2;e<l;e++){const s=e*3,c=e*o,f=t[c];if(f>99998)continue;const p=t[c+1],r=t[c+2],_=-f,y=-p,M=-r,u=_*_+y*y+M*M;if(u<1e4){t[c]=99999,b++;continue}const n=A*g/u,d=1/Math.sqrt(u);let z=_*d*n,a=y*d*n,m=M*d*n;const w=t[o],I=t[o+1],P=t[o+2],S=w-f,q=I-p,T=P-r,C=S*S+q*q+T*T;if(C>100){const B=A*E/C,R=1/Math.sqrt(C);z+=S*R*B,a+=q*R*B,m+=T*R*B}h[s]=z,h[s+1]=a,h[s+2]=m}}function N(i,e){for(let s=2;s<l;s++){const c=s*3,f=s*o;let p=0,r=0,_=0;const y=t[f];if(y>99998)continue;const M=t[f+1],u=t[f+2];for(let n=0;n<l;n++){if(s===n)continue;const d=t[n*o];if(d>99998)continue;const z=t[n*o+1],a=t[n*o+2],m=d-y,w=z-M,I=a-u;let P=m*m+w*w+I*I;if(e&&s>1&&n>1&&P<H){t[n*o]=99999,b++;continue}if(P<400){n===0&&(t[f]=99999,b++);continue}const S=A*x[n]/P,q=1/Math.sqrt(P);p+=m*q*S,r+=w*q*S,_+=I*q*S}h[c]=p,h[c+1]=r,h[c+2]=_}}function O(i){for(let e=2;e<l;e++){const s=e*o,c=e*3;t[s]>99998||(t[s+3]+=h[c]*i,t[s+4]+=h[c+1]*i,t[s+5]+=h[c+2]*i,t[s]+=t[s+3]*i,t[s+1]+=t[s+4]*i,t[s+2]+=t[s+5]*i)}}let F;function Q(){F&&clearInterval(F),F=setInterval(()=>{const i=performance.now();if(l>2){const s=.016666666666666666;D==="simple"?L():N(s,D==="extreme"),O(s)}const e=performance.now()-i;self.postMessage({type:"physics_report",physicsStepTime:e,consumedParticles:b})},1e3/60)}self.onmessage=i=>{const{type:e,...s}=i.data;if(e==="init")k=s.sharedBuffer,v=s.maxParticles,g=s.blackHoleMass,t=new Float32Array(k),h=new Float32Array(v*3),x=new Float32Array(v),x[0]=g,x[1]=E,l=2,Q(),self.postMessage({type:"ready"});else if(e==="set_particles"){const c=Math.min(v-2,s.count),f=l;if(l=c+2,l>f)for(let p=f;p<l;p++){const r=p*o,_=2e3+Math.random()*8e3,y=2*Math.PI*Math.random(),M=Math.acos(2*Math.random()-1)-Math.PI/2,u=_*Math.cos(y)*Math.cos(M),n=_*Math.sin(M)*.5,d=_*Math.sin(y)*Math.cos(M);t[r]=u,t[r+1]=n,t[r+2]=d;const z=Math.sqrt(A*g/_)*(.8+Math.random()*.2),a=new Float32Array([-d,0,u]),m=Math.sqrt(a[0]*a[0]+a[2]*a[2]);m>1e-9&&(a[0]/=m,a[2]/=m),t[r+3]=a[0]*z,t[r+4]=(Math.random()-.5)*20,t[r+5]=a[2]*z,x[p]=1+Math.random()*5}}else e==="set_mass"?(g=s.mass,x&&(x[0]=g)):e==="set_quality"?D=s.quality:e==="reset"?(l=2,b=0):e==="update_moon"&&(t[o]=s.x,t[o+1]=s.y,t[o+2]=s.z)}})();
