(function(){"use strict";console.log("[physics.worker] Script loaded and executing.");let t,h,x,q=0,l=0;const a=6;let v=6.674,z=4e5,T="simple",P=0;const R=5e4,B=25;function L(c){for(let e=2;e<l;e++){const s=e*3,o=e*a,f=t[o];if(f>99998)continue;const p=t[o+1],r=t[o+2],_=-f,u=-p,y=-r,M=_*_+u*u+y*y;if(M<1e4){t[o]=99999,P++;continue}const n=v*z/M,d=1/Math.sqrt(M);let g=_*d*n,i=u*d*n,m=y*d*n;const A=t[a],I=t[a+1],b=t[a+2],S=A-f,w=I-p,k=b-r,F=S*S+w*w+k*k;if(F>100){const D=v*R/F,C=1/Math.sqrt(F);g+=S*C*D,i+=w*C*D,m+=k*C*D}h[s]=g,h[s+1]=i,h[s+2]=m}}function N(c,e){for(let s=2;s<l;s++){const o=s*3,f=s*a;let p=0,r=0,_=0;const u=t[f];if(u>99998)continue;const y=t[f+1],M=t[f+2];for(let n=0;n<l;n++){if(s===n)continue;const d=t[n*a];if(d>99998)continue;const g=t[n*a+1],i=t[n*a+2],m=d-u,A=g-y,I=i-M;let b=m*m+A*A+I*I;if(e&&s>1&&n>1&&b<B){t[n*a]=99999,P++;continue}if(b<400){n===0&&(t[f]=99999,P++);continue}const S=v*x[n]/b,w=1/Math.sqrt(b);p+=m*w*S,r+=A*w*S,_+=I*w*S}h[o]=p,h[o+1]=r,h[o+2]=_}}function H(c){for(let e=2;e<l;e++){const s=e*a,o=e*3;t[s]>99998||(t[s+3]+=h[o]*c,t[s+4]+=h[o+1]*c,t[s+5]+=h[o+2]*c,t[s]+=t[s+3]*c,t[s+1]+=t[s+4]*c,t[s+2]+=t[s+5]*c)}}let E;function O(){E&&clearInterval(E),E=setInterval(()=>{try{const c=performance.now();if(l>2){const s=.016666666666666666;T==="simple"?L(s):N(s,T==="extreme"),H(s)}const e=performance.now()-c;self.postMessage({type:"physics_update",physicsStepTime:e,consumedParticles:P,data:t.buffer})}catch(c){self.postMessage({type:"worker_error",error:{message:c.message,stack:c.stack}}),clearInterval(E)}},1e3/60)}self.onmessage=c=>{const{type:e,...s}=c.data;if(e==="init"){q=s.maxParticles,z=s.blackHoleMass;const o=new ArrayBuffer(q*a*Float32Array.BYTES_PER_ELEMENT);t=new Float32Array(o),h=new Float32Array(q*3),x=new Float32Array(q),x[0]=z,x[1]=R,l=2,O()}else if(e==="set_particles"){const o=Math.min(q-2,s.count),f=l;if(l=o+2,l>f)for(let p=f;p<l;p++){const r=p*a,_=2e3+Math.random()*8e3,u=2*Math.PI*Math.random(),y=Math.acos(2*Math.random()-1)-Math.PI/2,M=_*Math.cos(u)*Math.cos(y),n=_*Math.sin(y)*.5,d=_*Math.sin(u)*Math.cos(y);t[r]=M,t[r+1]=n,t[r+2]=d;const g=Math.sqrt(v*z/_)*(.8+Math.random()*.2),i=new Float32Array([-d,0,M]),m=Math.sqrt(i[0]*i[0]+i[2]*i[2]);m>1e-9&&(i[0]/=m,i[2]/=m),t[r+3]=i[0]*g,t[r+4]=(Math.random()-.5)*20,t[r+5]=i[2]*g,x[p]=1+Math.random()*5}}else if(e==="set_mass")z=s.mass,x&&(x[0]=z);else if(e==="set_quality")T=s.quality;else if(e==="reset")l=2,P=0;else if(e==="update_moon"){if(!t)return;t[a]=s.x,t[a+1]=s.y,t[a+2]=s.z}}})();
