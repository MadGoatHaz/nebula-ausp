(function(){"use strict";console.log("[physics.worker] Script loaded and executing.");let t,l,b,P=0,r=0;const c=6;let q=6.674,x=4e5,C="simple",A=0;const R=5e4,T=25;function k(i){for(let s=2;s<r;s++){const o=s*3,e=s*c,a=t[e];if(a>99998)continue;const h=t[e+1],u=t[e+2],_=-a,p=-h,y=-u,d=_*_+p*p+y*y;if(d<1e4){t[e]=99999,A++;continue}const n=q*x/d,f=1/Math.sqrt(d);let E=_*f*n,F=p*f*n,w=y*f*n;const z=t[c],S=t[c+1],g=t[c+2],M=z-a,m=S-h,O=g-u,v=M*M+m*m+O*O;if(v>100){const D=q*R/v,I=1/Math.sqrt(v);E+=M*I*D,F+=m*I*D,w+=O*I*D}l[o]=E,l[o+1]=F,l[o+2]=w}}function B(i,s){for(let o=2;o<r;o++){const e=o*3,a=o*c;let h=0,u=0,_=0;const p=t[a];if(p>99998)continue;const y=t[a+1],d=t[a+2];for(let n=0;n<r;n++){if(o===n)continue;const f=t[n*c];if(f>99998)continue;const E=t[n*c+1],F=t[n*c+2],w=f-p,z=E-y,S=F-d;let g=w*w+z*z+S*S;if(s&&o>1&&n>1&&g<T){t[n*c]=99999,A++;continue}if(g<400){n===0&&(t[a]=99999,A++);continue}const M=q*b[n]/g,m=1/Math.sqrt(g);h+=w*m*M,u+=z*m*M,_+=S*m*M}l[e]=h,l[e+1]=u,l[e+2]=_}}function N(i){for(let s=2;s<r;s++){const o=s*c,e=s*3;t[o]>99998||(t[o+3]+=l[e]*i,t[o+4]+=l[e+1]*i,t[o+5]+=l[e+2]*i,t[o]+=t[o+3]*i,t[o+1]+=t[o+4]*i,t[o+2]+=t[o+5]*i)}}function H(i){const s=r;if(r=Math.min(P,i),r>s)for(let o=s;o<r;o++){const e=o*c,a=2e3+Math.random()*8e3,h=2*Math.PI*Math.random(),u=Math.acos(2*Math.random()-1)-Math.PI/2,_=a*Math.cos(h)*Math.cos(u),p=a*Math.sin(u)*.5,y=a*Math.sin(h)*Math.cos(u);t[e]=_,t[e+1]=p,t[e+2]=y;const d=Math.sqrt(q*x/a)*(.8+Math.random()*.2),n=new Float32Array([-y,0,_]),f=Math.sqrt(n[0]*n[0]+n[2]*n[2]);f>1e-9&&(n[0]/=f,n[2]/=f),t[e+3]=n[0]*d,t[e+4]=(Math.random()-.5)*20,t[e+5]=n[2]*d,b[o]=1+Math.random()*5}}self.onmessage=i=>{const{type:s,...o}=i.data;if(s==="init"){P=o.maxParticles;const a=new ArrayBuffer(P*c*Float32Array.BYTES_PER_ELEMENT);t=new Float32Array(a),l=new Float32Array(P*3),b=new Float32Array(P),x=4e5,b[0]=x,b[1]=R,r=2,self.postMessage({type:"initialized",buffer:a},[a]);return}if(i.data.buffer)t=new Float32Array(i.data.buffer);else{console.error(`[physics.worker] Received message type '${s}' without a buffer. Halting.`);return}o.hasOwnProperty("particleCount")&&H(o.particleCount),o.hasOwnProperty("bhMass")&&(x=o.bhMass,b[0]=x),o.hasOwnProperty("quality")&&(C=o.quality),o.hasOwnProperty("moon_x")&&(t[c]=o.moon_x,t[c+1]=o.moon_y,t[c+2]=o.moon_z);const e=1/60;r>2&&(C==="simple"?k():B(e,C==="extreme"),N(e)),self.postMessage({type:"physics_update",buffer:t.buffer,particleCount:r,consumedParticles:A},[t.buffer])}})();
