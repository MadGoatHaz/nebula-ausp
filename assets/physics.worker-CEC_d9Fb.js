(function(){"use strict";console.log("[physics.worker] Script loaded and executing.");let t,_,S,P=0,y=0;const s=6;let k=6.674,q=4e5,F="simple",E=0;const I=5e4,R=25;function B(i){for(let n=2;n<y;n++){const e=n*3,a=n*s,f=t[a];if(f>99998)continue;const x=t[a+1],r=t[a+2],d=-f,u=-x,l=-r,h=d*d+u*u+l*l;if(h<1e4){t[a]=99999,E++;continue}const o=k*q/h,m=1/Math.sqrt(h);let w=d*m*o,A=u*m*o,M=l*m*o;const b=t[s],c=t[s+1],p=t[s+2],g=b-f,z=c-x,T=p-r,v=g*g+z*z+T*T;if(v>100){const C=k*I/v,D=1/Math.sqrt(v);w+=g*D*C,A+=z*D*C,M+=T*D*C}_[e]=w,_[e+1]=A,_[e+2]=M}}function N(i,n){for(let e=2;e<y;e++){const a=e*3,f=e*s;let x=0,r=0,d=0;const u=t[f];if(u>99998)continue;const l=t[f+1],h=t[f+2];for(let o=0;o<y;o++){if(e===o)continue;const m=t[o*s];if(m>99998)continue;const w=t[o*s+1],A=t[o*s+2],M=m-u,b=w-l,c=A-h;let p=M*M+b*b+c*c;if(n&&e>1&&o>1&&p<R){t[o*s]=99999,E++;continue}if(p<400){o===0&&(t[f]=99999,E++);continue}const g=k*S[o]/p,z=1/Math.sqrt(p);x+=M*z*g,r+=b*z*g,d+=c*z*g}_[a]=x,_[a+1]=r,_[a+2]=d}}function H(i){for(let n=2;n<y;n++){const e=n*s,a=n*3;t[e]>99998||(t[e+3]+=_[a]*i,t[e+4]+=_[a+1]*i,t[e+5]+=_[a+2]*i,t[e]+=t[e+3]*i,t[e+1]+=t[e+4]*i,t[e+2]+=t[e+5]*i)}}self.onmessage=i=>{const{type:n,...e}=i.data;if(n==="init"){P=e.maxParticles,q=e.blackHoleMass;const r=new ArrayBuffer(P*s*Float32Array.BYTES_PER_ELEMENT);t=new Float32Array(r),_=new Float32Array(P*3),S=new Float32Array(P),S[0]=q,S[1]=I,y=2,self.postMessage({type:"initialized",buffer:r},[r]);return}if(i.data.buffer)t=new Float32Array(i.data.buffer);else{console.warn(`[physics.worker] Received message type '${n}' without a buffer.`);return}switch(n){case"set_particles":const r=y,d=Math.min(P,e.count);if(y=d,d>r)for(let u=r;u<d;u++){const l=u*s,h=2e3+Math.random()*8e3,o=2*Math.PI*Math.random(),m=Math.acos(2*Math.random()-1)-Math.PI/2,w=h*Math.cos(o)*Math.cos(m),A=h*Math.sin(m)*.5,M=h*Math.sin(o)*Math.cos(m);t[l]=w,t[l+1]=A,t[l+2]=M;const b=Math.sqrt(k*q/h)*(.8+Math.random()*.2),c=new Float32Array([-M,0,w]),p=Math.sqrt(c[0]*c[0]+c[2]*c[2]);p>1e-9&&(c[0]/=p,c[2]/=p),t[l+3]=c[0]*b,t[l+4]=(Math.random()-.5)*20,t[l+5]=c[2]*b,S[u]=1+Math.random()*5}break;case"set_mass":q=e.mass,S[0]=q;break;case"set_quality":F=e.quality;break;case"update_moon":t[s]=e.x,t[s+1]=e.y,t[s+2]=e.z;break}const a=performance.now(),f=1/60;y>2&&(F==="simple"?B():N(f,F==="extreme"),H(f));const x=performance.now()-a;self.postMessage({type:"physics_update",buffer:t.buffer,particleCount:y,consumedParticles:E,executionTime:x},[t.buffer])}})();
