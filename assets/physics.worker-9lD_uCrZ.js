(function(){"use strict";let t,h,x,g=0,l=0;const a=6;let v=6.674,q=4e5,E="simple",w=0;const B=5e4,L=25;function N(i){for(let e=2;e<l;e++){const s=e*3,n=e*a,f=t[n];if(f>99998)continue;const p=t[n+1],r=t[n+2],_=-f,u=-p,y=-r,d=_*_+u*u+y*y;if(d<1e4){t[n]=99999,w++;continue}const o=v*q/d,M=1/Math.sqrt(d);let S=_*M*o,c=u*M*o,m=y*M*o;const A=t[a],I=t[a+1],P=t[a+2],z=A-f,b=I-p,F=P-r,D=z*z+b*b+F*F;if(D>100){const C=v*B/D,R=1/Math.sqrt(D);S+=z*R*C,c+=b*R*C,m+=F*R*C}h[s]=S,h[s+1]=c,h[s+2]=m}}function k(i,e){for(let s=2;s<l;s++){const n=s*3,f=s*a;let p=0,r=0,_=0;const u=t[f];if(u>99998)continue;const y=t[f+1],d=t[f+2];for(let o=0;o<l;o++){if(s===o)continue;const M=t[o*a];if(M>99998)continue;const S=t[o*a+1],c=t[o*a+2],m=M-u,A=S-y,I=c-d;let P=m*m+A*A+I*I;if(e&&s>1&&o>1&&P<L){t[o*a]=99999,w++;continue}if(P<400){o===0&&(t[f]=99999,w++);continue}const z=v*x[o]/P,b=1/Math.sqrt(P);p+=m*b*z,r+=A*b*z,_+=I*b*z}h[n]=p,h[n+1]=r,h[n+2]=_}}function H(i){for(let e=2;e<l;e++){const s=e*a,n=e*3;t[s]>99998||(t[s+3]+=h[n]*i,t[s+4]+=h[n+1]*i,t[s+5]+=h[n+2]*i,t[s]+=t[s+3]*i,t[s+1]+=t[s+4]*i,t[s+2]+=t[s+5]*i)}}let T;function O(){T&&clearInterval(T),T=setInterval(()=>{const i=performance.now();if(l>2){const s=.016666666666666666;E==="simple"?N():k(s,E==="extreme"),H(s)}const e=performance.now()-i;self.postMessage({type:"physics_update",physicsStepTime:e,consumedParticles:w,data:t.buffer})},1e3/60)}self.onmessage=i=>{const{type:e,...s}=i.data;if(e==="init"){g=s.maxParticles,q=s.blackHoleMass;const n=new ArrayBuffer(g*a*Float32Array.BYTES_PER_ELEMENT);t=new Float32Array(n),h=new Float32Array(g*3),x=new Float32Array(g),x[0]=q,x[1]=B,l=2,O(),self.postMessage({type:"ready"})}else if(e==="set_particles"){const n=Math.min(g-2,s.count),f=l;if(l=n+2,l>f)for(let p=f;p<l;p++){const r=p*a,_=2e3+Math.random()*8e3,u=2*Math.PI*Math.random(),y=Math.acos(2*Math.random()-1)-Math.PI/2,d=_*Math.cos(u)*Math.cos(y),o=_*Math.sin(y)*.5,M=_*Math.sin(u)*Math.cos(y);t[r]=d,t[r+1]=o,t[r+2]=M;const S=Math.sqrt(v*q/_)*(.8+Math.random()*.2),c=new Float32Array([-M,0,d]),m=Math.sqrt(c[0]*c[0]+c[2]*c[2]);m>1e-9&&(c[0]/=m,c[2]/=m),t[r+3]=c[0]*S,t[r+4]=(Math.random()-.5)*20,t[r+5]=c[2]*S,x[p]=1+Math.random()*5}}else if(e==="set_mass")q=s.mass,x&&(x[0]=q);else if(e==="set_quality")E=s.quality;else if(e==="reset")l=2,w=0;else if(e==="update_moon"){if(!t)return;t[a]=s.x,t[a+1]=s.y,t[a+2]=s.z}}})();
