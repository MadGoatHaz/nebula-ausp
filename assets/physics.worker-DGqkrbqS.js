(function(){"use strict";console.log("[physics.worker] Script loaded and executing.");let t,d,x,I=0,f=0;const i=6;let A=6.674,z=4e5,C="simple",F=0;const D=5e4,H=25;function R(_){for(let h=2;h<f;h++){const o=h*3,l=h*i,m=t[l];if(m>99998)continue;const P=t[l+1],r=t[l+2],n=-m,a=-P,M=-r,u=n*n+a*a+M*M;if(u<1e4){t[l]=99999,F++;continue}const s=A*z/u,p=1/Math.sqrt(u);let b=n*p*s,y=a*p*s,c=M*p*s;const e=t[i],g=t[i+1],w=t[i+2],S=e-m,q=g-P,E=w-r,T=S*S+q*q+E*E;if(T>100){const k=A*D/T,v=1/Math.sqrt(T);b+=S*v*k,y+=q*v*k,c+=E*v*k}d[o]=b,d[o+1]=y,d[o+2]=c}}function B(_,h){for(let o=2;o<f;o++){const l=o*3,m=o*i;let P=0,r=0,n=0;const a=t[m];if(a>99998)continue;const M=t[m+1],u=t[m+2];for(let s=0;s<f;s++){if(o===s)continue;const p=t[s*i];if(p>99998)continue;const b=t[s*i+1],y=t[s*i+2],c=p-a,e=b-M,g=y-u;let w=c*c+e*e+g*g;if(h&&o>1&&s>1&&w<H){t[s*i]=99999,F++;continue}if(w<400){s===0&&(t[m]=99999,F++);continue}const S=A*x[s]/w,q=1/Math.sqrt(w);P+=c*q*S,r+=e*q*S,n+=g*q*S}d[l]=P,d[l+1]=r,d[l+2]=n}}function N(_){for(let h=2;h<f;h++){const o=h*i,l=h*3;t[o]>99998||(t[o+3]+=d[l]*_,t[o+4]+=d[l+1]*_,t[o+5]+=d[l+2]*_,t[o]+=t[o+3]*_,t[o+1]+=t[o+4]*_,t[o+2]+=t[o+5]*_)}}self.onmessage=_=>{const{type:h,...o}=_.data;if(!o.buffer){if(h==="init"){console.log("[physics.worker] Initializing..."),I=o.maxParticles,z=o.blackHoleMass;const r=new ArrayBuffer(I*i*Float32Array.BYTES_PER_ELEMENT);t=new Float32Array(r),d=new Float32Array(I*3),x=new Float32Array(I),f=0,self.postMessage({type:"initialized",buffer:t.buffer},[t.buffer])}return}if(t=new Float32Array(o.buffer),o.particleCount&&o.particleCount!==f){const r=f;if(f=o.particleCount,f>r)for(let n=r;n<f;n++){if(n===0){x[n]=z;continue}if(n===1){x[n]=D;continue}const a=n*i,M=2e3+Math.random()*8e3,u=2*Math.PI*Math.random(),s=Math.acos(2*Math.random()-1)-Math.PI/2,p=M*Math.cos(u)*Math.cos(s),b=M*Math.sin(s)*.5,y=M*Math.sin(u)*Math.cos(s);t[a]=p,t[a+1]=b,t[a+2]=y;const c=Math.sqrt(A*z/M)*(.8+Math.random()*.2),e=new Float32Array([-y,0,p]),g=Math.sqrt(e[0]*e[0]+e[2]*e[2]);g>1e-9&&(e[0]/=g,e[2]/=g),t[a+3]=e[0]*c,t[a+4]=(Math.random()-.5)*20,t[a+5]=e[2]*c,x[n]=1+Math.random()*5}}if(o.blackHoleMass&&(z=o.blackHoleMass,x[0]=z),o.quality&&(C=o.quality),o.moonPosition&&(t[i]=o.moonPosition.x,t[i+1]=o.moonPosition.y,t[i+2]=o.moonPosition.z),o.reset){F=0;for(let r=2;r<f;r++){const n=r*i,a=2e3+Math.random()*8e3,M=2*Math.PI*Math.random(),u=Math.acos(2*Math.random()-1)-Math.PI/2,s=a*Math.cos(M)*Math.cos(u),p=a*Math.sin(u)*.5,b=a*Math.sin(M)*Math.cos(u);t[n]=s,t[n+1]=p,t[n+2]=b;const y=Math.sqrt(A*z/a)*(.8+Math.random()*.2),c=new Float32Array([-b,0,s]),e=Math.sqrt(c[0]*c[0]+c[2]*c[2]);e>1e-9&&(c[0]/=e,c[2]/=e),t[n+3]=c[0]*y,t[n+4]=(Math.random()-.5)*20,t[n+5]=c[2]*y,x[r]=1+Math.random()*5}}const l=performance.now(),m=1/60;f>2&&(C==="simple"?R():B(m,C==="extreme"),N(m));const P=performance.now()-l;self.postMessage({type:"physics_update",buffer:t.buffer,particleCount:f,physicsStepTime:P,consumedParticles:F},[t.buffer])}})();
