(function(){"use strict";const Q=.03333333333333333;let J="simple",O=0,z=0,t=null,X=null,k=0,C=0,w=5e6;function et(n){return!Number.isFinite(n)||n<=0?5e6:n<1e5?1e5:n>1e8?1e8:n}function U(){return w/5e6}function K(){return 500*Math.cbrt(w/5e6)}function V(n){const f=t[n];return Number.isFinite(f)&&f<99998}function st(n){const f=Math.max(2,Math.min(n,O));for(let e=0;e<f;e++){const s=e*6,y=Math.random();let S;y<.25?S=400+Math.random()*1800:y<.7?S=1600+Math.random()*4800:S=800+Math.random()*12e3;const r=Math.random()*Math.PI*2,i=Math.random();let M;if(i<.2)M=(Math.random()-.5)*80;else if(i<.55){const m=150+Math.random()*600;M=(Math.random()-.5)*m}else{const m=Math.random()>.5?1:-1,B=400+Math.random()*3200;M=m*B}const h=Math.cos(r)*S,u=Math.sin(r)*S;t[s]=h,t[s+1]=M,t[s+2]=u;const l=Math.sqrt(.006674*w/Math.max(S,300*2)),E=.5;let _=-Math.sin(r)*l,A=Math.cos(r)*l,d=0;if(_*=1+(Math.random()-.5)*E,A*=1+(Math.random()-.5)*E,d=(Math.random()-.5)*l*.4,Math.abs(M)>500){const m=M>0?1:-1;d+=m*l*.12}t[s+3]=_,t[s+4]=d,t[s+5]=A,X[e]=1}for(let e=f;e<O;e++){const s=e*6;t[s]=99999,t[s+1]=0,t[s+2]=0,t[s+3]=0,t[s+4]=0,t[s+5]=0,X[e]=0}z=f}function W(n){const f=Math.max(0,Math.min(n,O));if(C=0,f===0){for(let e=0;e<O;e++){const s=e*6;t[s]=99999,t[s+1]=0,t[s+2]=0,t[s+3]=0,t[s+4]=0,t[s+5]=0,X[e]=0}z=0;return}st(f)}function at(n){const f=Math.random();let e;f<.4?e=5e3+Math.random()*3e3:f<.8?e=8e3+Math.random()*4e3:e=11e3+Math.random()*5e3;const s=Math.random()*Math.PI*2,y=Math.random();let S;y<.4?S=(Math.random()-.5)*400:S=(Math.random()>.5?1:-1)*(600+Math.random()*2600);const r=Math.cos(s)*e,i=Math.sin(s)*e,h=Math.sqrt(.006674*w/Math.max(e,300*2));let u=-Math.sin(s)*h,c=Math.cos(s)*h;const l=.22;u+=-r/e*h*.5*l,c+=-i/e*h*.5*l;let E=(Math.random()-.5)*h*.2;const _=.35;u*=1+(Math.random()-.5)*_,c*=1+(Math.random()-.5)*_;let A=u*u+E*E+c*c;if(A>1200*1200){const d=1200/Math.sqrt(A);u*=d,E*=d,c*=d}t[n]=r,t[n+1]=S,t[n+2]=i,t[n+3]=u,t[n+4]=E,t[n+5]=c,X[n/6]=1}function $(n){C++,at(n)}function ot(){const n=U();return 1+1.5*Math.min(3,Math.sqrt(n))}function tt(n){const f=U();let e=.4*Math.sqrt(f);e>.9&&(e=.9);let y=.02*(.8+1.2*Math.sqrt(f));const S=K(),r=S*S;for(let i=0;i<z;i++){const M=i*6;if(!V(M))continue;let h=t[M],u=t[M+1],c=t[M+2];const l=Math.sqrt(h*h+c*c)||1,E=-c/l,_=h/l,A=-h,d=-u*.3,m=-c,B=A*A+d*d+m*m,D=Math.max(B,300*300),T=1/Math.sqrt(D),P=.006674*w/D,j=Math.sqrt(B);let g=y;j<900*2&&(g*=ot());let F=E*e+A*T*P*g,H=d*T*P*g*.4,G=_*e+m*T*P*g;F+=(Math.random()-.5)*.02,H+=(Math.random()-.5)*.01,G+=(Math.random()-.5)*.02;const N=M+3;let q=t[N],a=t[N+1],o=t[N+2];q+=F*n,a+=H*n,o+=G*n,q*=.999,a*=.999,o*=.999;let p=q*q+a*a+o*o;if(p>1200*1200){const R=1200/Math.sqrt(p);q*=R,a*=R,o*=R}const x=h+q*n,I=u+a*n,v=c+o*n;if(x*x+I*I+v*v<r){$(M);continue}t[N]=q,t[N+1]=a,t[N+2]=o,t[M]=x,t[M+1]=I,t[M+2]=v}}function nt(n,f,e){const s=z;if(s<=2)return;const S=Math.max(1,Math.floor(s/72)),r=U(),M=.018*(.8+1.3*Math.sqrt(r));let h=.18*Math.sqrt(r);h>.6&&(h=.6);for(let u=0;u<s;u++){const c=u*6;if(!V(c))continue;const l=t[c],E=t[c+1],_=t[c+2];let A=0,d=0,m=0;{const a=-l,o=-E,p=-_,x=a*a+o*o+p*p,I=300*300,v=Math.max(x,I),b=1/Math.sqrt(v),R=.006674*w*b*b;A+=a*b*R*M,d+=o*b*R*M*.25,m+=p*b*R*M}{const a=Math.sqrt(l*l+_*_)||1,o=Math.sqrt(l*l+E*E+_*_);if(o>300&&o<8e3){const p=-_/a,x=l/a,I=300*2,R=1-.4*Math.min(1,Math.max(0,(o-I)/(8e3-I)));A+=p*h*R,m+=x*h*R}}for(let a=0;a<s;a+=S){if(a===u)continue;const o=a*6;if(!V(o))continue;const p=t[o],x=t[o+1],I=t[o+2],v=p-l,b=x-E,R=I-_,Y=v*v+b*b+R*R;if(Y<200||Y>8e3*8e3)continue;const L=1/Math.sqrt(Y),Z=f*L*L;A+=v*L*Z*.5,d+=b*L*Z*.25,m+=R*L*Z*.5}if(e>0){const a=p=>{const x=Math.sin(p*12.9898)*43758.5453;return(x-Math.floor(x))*2-1},o=e*.5;A+=a(l*.13+E*.27+_*.19)*o,d+=a(l*.31-_*.17)*o*.3,m+=a(E*.41+l*.07)*o}const B=c+3;let D=t[B],T=t[B+1],P=t[B+2];D+=A*n,T+=d*n,P+=m*n,D*=.999,T*=.999,P*=.999;let j=D*D+T*T+P*P;if(j>1200*1200){const a=1200/Math.sqrt(j);D*=a,T*=a,P*=a}const g=l+D*n,F=E+T*n,H=_+P*n,G=K(),N=G*G;if(g*g+F*F+H*H<N){$(c);continue}t[B]=D,t[B+1]=T,t[B+2]=P,t[c]=g,t[c+1]=F,t[c+2]=H}}self.onmessage=n=>{const{type:f,...e}=n.data;if(f==="init"){O=e.maxParticles||5e5;const i=new ArrayBuffer(O*6*Float32Array.BYTES_PER_ELEMENT);t=new Float32Array(i),X=new Float32Array(O),W(1e4),k=performance.now(),self.postMessage({type:"initialized",buffer:i},[i]);return}if(!t||!n.data.buffer)return;t=new Float32Array(n.data.buffer);let s=!1,y=!1;if(Object.prototype.hasOwnProperty.call(e,"particleCount")){const i=parseInt(e.particleCount,10);Number.isFinite(i)&&(W(i),s=!0,y=!0)}if(Object.prototype.hasOwnProperty.call(e,"quality")){const i=String(e.quality);(i==="simple"||i==="complex"||i==="extreme")&&(J=i,y=!0)}Object.prototype.hasOwnProperty.call(e,"bhMass")&&(w=et(e.bhMass)),s?self.postMessage({type:"state_updated"}):y&&self.postMessage({type:"state_updated"});const S=performance.now();let r=(S-k)/1e3;if(k=S,(!Number.isFinite(r)||r<=0)&&(r=1/60),r>Q&&(r=Q),C=0,z>0)switch(J){case"simple":tt(r);break;case"complex":nt(r,.5,0);break;case"extreme":nt(r,.9,.15);break;default:tt(r)}self.postMessage({type:"physics_update",buffer:t.buffer,particleCount:z,consumedParticles:C},[t.buffer])}})();
